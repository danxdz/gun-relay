<!-- Notification System -->
<div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;"></div>

<!-- Enhanced Database Management Panel -->
<div id="databasePanel" style="padding: 20px; background: #1a1a1a; border-radius: 10px; margin: 20px 0;">
  <h2 style="color: #4ade80; margin-bottom: 20px;">üìä Database Management</h2>
  
  <!-- Current Status -->
  <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3>Current Status</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
      <div>
        <label style="color: #888;">Instance Name:</label>
        <strong id="currentInstance" style="color: #4ade80;">Loading...</strong>
      </div>
      <div>
        <label style="color: #888;">Database Size:</label>
        <strong id="dbSize">Calculating...</strong>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3>Quick Actions</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
      <button onclick="createSnapshot()" class="success" style="padding: 10px 20px;">
        üì∏ Create Snapshot
      </button>
      <button onclick="showCompleteReset()" class="danger" style="padding: 10px 20px;">
        üîÑ Complete Reset (Server + Clients)
      </button>
      <button onclick="showSnapshots()" style="padding: 10px 20px;">
        üìÅ Manage Snapshots
      </button>
    </div>
  </div>

  <!-- Complete Reset Dialog -->
  <div id="resetDialog" style="display: none; background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ef4444;">
    <h3 style="color: #ef4444;">‚ö†Ô∏è Complete System Reset</h3>
    <p style="margin: 15px 0; color: #fbbf24;">
      This will completely reset both the server database and all connected Whisperz clients.
    </p>
    
    <div style="margin: 20px 0;">
      <label style="display: block; margin-bottom: 10px;">New Instance Name:</label>
      <input type="text" id="newInstanceName" placeholder="e.g., production-v2" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 5px; color: white;">
      <small style="color: #888;">Leave empty to auto-generate (v[timestamp])</small>
    </div>
    
    <div style="margin: 20px 0;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="createBackup" checked style="margin-right: 10px;">
        Create backup snapshot before reset
      </label>
    </div>
    
    <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin: 20px 0;">
      <strong>What will happen:</strong>
      <ul style="margin: 10px 0; padding-left: 20px; color: #fbbf24;">
        <li>Server database will be completely cleared</li>
        <li>All Whisperz clients will detect the change</li>
        <li>Clients will clear their local data automatically</li>
        <li>Server will restart (takes ~5 seconds)</li>
        <li>All users will need to log in again</li>
      </ul>
    </div>
    
    <div style="display: flex; gap: 10px;">
      <button onclick="executeCompleteReset()" class="danger" style="padding: 10px 20px;">
        ‚ö†Ô∏è Confirm Reset
      </button>
      <button onclick="hideResetDialog()" style="padding: 10px 20px;">
        Cancel
      </button>
    </div>
  </div>

  <!-- Snapshots Manager -->
  <div id="snapshotsDialog" style="display: none; background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <h3>üìÅ Database Snapshots</h3>
    <div id="snapshotsList" style="margin: 20px 0; max-height: 300px; overflow-y: auto;">
      <!-- Snapshots will be loaded here -->
    </div>
    <button onclick="hideSnapshots()" style="padding: 10px 20px;">
      Close
    </button>
  </div>
</div>

<style>
  .notification {
    background: #2a2a2a;
    border-left: 4px solid #4ade80;
    padding: 15px 20px;
    margin-bottom: 10px;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .notification.success {
    border-left-color: #4ade80;
  }
  
  .notification.error {
    border-left-color: #ef4444;
  }
  
  .notification.warning {
    border-left-color: #fbbf24;
  }
  
  .notification.info {
    border-left-color: #60a5fa;
  }
  
  .notification-icon {
    font-size: 20px;
  }
  
  .notification-content {
    flex: 1;
  }
  
  .notification-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: white;
  }
  
  .notification-message {
    color: #ccc;
    font-size: 14px;
  }
  
  .notification-close {
    cursor: pointer;
    color: #888;
    font-size: 20px;
    line-height: 1;
    padding: 0 5px;
    transition: color 0.2s;
  }
  
  .notification-close:hover {
    color: white;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100%);
    }
  }
</style>

<script>
// Notification System
function showNotification(message, type = 'info', duration = 5000) {
  const container = document.getElementById('notificationContainer');
  if (!container) return;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  // Parse message - could be string or object with title and message
  let title = '';
  let msg = message;
  if (typeof message === 'object' && message.title) {
    title = message.title;
    msg = message.message || '';
  } else if (message.includes('\n')) {
    const parts = message.split('\n');
    title = parts[0];
    msg = parts.slice(1).join('\n');
  }
  
  notification.innerHTML = `
    <span class="notification-icon">${icons[type]}</span>
    <div class="notification-content">
      ${title ? `<div class="notification-title">${title}</div>` : ''}
      <div class="notification-message">${msg}</div>
    </div>
    <span class="notification-close" onclick="this.parentElement.remove()">√ó</span>
  `;
  
  container.appendChild(notification);
  
  // Auto-remove after duration
  if (duration > 0) {
    setTimeout(() => {
      notification.style.animation = 'fadeOut 0.3s ease-out';
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, duration);
  }
  
  return notification;
}

// Helper functions for different notification types
function notifySuccess(message, duration = 4000) {
  return showNotification(message, 'success', duration);
}

function notifyError(message, duration = 6000) {
  return showNotification(message, 'error', duration);
}

function notifyWarning(message, duration = 5000) {
  return showNotification(message, 'warning', duration);
}

function notifyInfo(message, duration = 4000) {
  return showNotification(message, 'info', duration);
}

// Database management functions
let dbSnapshots = [];

async function loadDatabaseStatus() {
  try {
    // Get current instance
    const instanceRes = await fetch('/admin/whisperz/instance', {
      headers: { 'X-Admin-Session': adminSession }
    });
    const instanceData = await instanceRes.json();
    document.getElementById('currentInstance').textContent = instanceData.instance || 'not_set';
    
    // Get snapshots
    const snapshotsRes = await fetch('/admin/database/snapshots', {
      headers: { 'X-Admin-Session': adminSession }
    });
    const snapshotsData = await snapshotsRes.json();
    dbSnapshots = snapshotsData.snapshots || [];
    
    // Calculate current DB size (approximate)
    document.getElementById('dbSize').textContent = 'N/A';
  } catch (err) {
    console.error('Error loading database status:', err);
  }
}

function showCompleteReset() {
  document.getElementById('resetDialog').style.display = 'block';
  document.getElementById('snapshotsDialog').style.display = 'none';
}

function hideResetDialog() {
  document.getElementById('resetDialog').style.display = 'none';
}

async function executeCompleteReset() {
  const newInstance = document.getElementById('newInstanceName').value.trim();
  const createBackup = document.getElementById('createBackup').checked;
  
  if (!confirm('Are you absolutely sure? This cannot be undone!')) {
    return;
  }
  
  try {
    const response = await fetch('/admin/database/complete-reset', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Session': adminSession
      },
      body: JSON.stringify({
        newInstance: newInstance || null,
        createSnapshot: createBackup
      })
    });
    
    const result = await response.json();
    if (result.success) {
      notifySuccess({
        title: 'Reset Successful!',
        message: `New instance: ${result.newInstance}. Server will restart in a moment.`
      });
      hideResetDialog();
      // Reload status after a delay
      setTimeout(() => loadDatabaseStatus(), 3000);
    } else {
      notifyError('Reset failed: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    notifyError('Error during reset: ' + err.message);
  }
}

async function createSnapshot() {
  const name = prompt('Snapshot name:', `Snapshot ${new Date().toLocaleString()}`);
  if (!name) return;
  
  const description = prompt('Description (optional):');
  
  try {
    const response = await fetch('/admin/database/snapshot', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Session': adminSession
      },
      body: JSON.stringify({ name, description })
    });
    
    const result = await response.json();
    if (result.success) {
      notifySuccess('Snapshot created successfully!');
      loadDatabaseStatus();
    } else {
      notifyError('Failed to create snapshot: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    notifyError('Error creating snapshot: ' + err.message);
  }
}

function showSnapshots() {
  document.getElementById('snapshotsDialog').style.display = 'block';
  document.getElementById('resetDialog').style.display = 'none';
  renderSnapshots();
}

function hideSnapshots() {
  document.getElementById('snapshotsDialog').style.display = 'none';
}

function renderSnapshots() {
  const container = document.getElementById('snapshotsList');
  
  if (dbSnapshots.length === 0) {
    container.innerHTML = '<p style="color: #888;">No snapshots available</p>';
    return;
  }
  
  container.innerHTML = dbSnapshots.map(snapshot => `
    <div style="background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <strong>${snapshot.name}</strong>
          <div style="color: #888; font-size: 0.9em; margin-top: 5px;">
            ${new Date(snapshot.created).toLocaleString()}
          </div>
          ${snapshot.description ? `<div style="color: #aaa; margin-top: 5px;">${snapshot.description}</div>` : ''}
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="restoreSnapshot('${snapshot.id}')" class="warning" style="padding: 5px 10px;">
            Restore
          </button>
          <button onclick="deleteSnapshot('${snapshot.id}')" class="danger" style="padding: 5px 10px;">
            Delete
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

async function restoreSnapshot(snapshotId) {
  const snapshot = dbSnapshots.find(s => s.id === snapshotId);
  if (!snapshot) return;
  
  if (!confirm(`Restore from snapshot "${snapshot.name}"?\n\nThis will replace the current database and restart the server.`)) {
    return;
  }
  
  try {
    const response = await fetch('/admin/database/restore', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Session': adminSession
      },
      body: JSON.stringify({ snapshotId })
    });
    
    const result = await response.json();
    if (result.success) {
      notifySuccess('Database restored! Server will restart.');
      setTimeout(() => loadDatabaseStatus(), 3000);
    } else {
      notifyError('Restore failed: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    notifyError('Error restoring snapshot: ' + err.message);
  }
}

async function deleteSnapshot(snapshotId) {
  const snapshot = dbSnapshots.find(s => s.id === snapshotId);
  if (!snapshot) return;
  
  if (!confirm(`Delete snapshot "${snapshot.name}"?`)) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/database/snapshot/${snapshotId}`, {
      method: 'DELETE',
      headers: {
        'X-Admin-Session': adminSession
      }
    });
    
    const result = await response.json();
    if (result.success) {
      notifySuccess('Snapshot deleted!');
      loadDatabaseStatus();
      renderSnapshots();
    } else {
      notifyError('Delete failed: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    notifyError('Error deleting snapshot: ' + err.message);
  }
}

// Load status on page load
if (typeof adminSession !== 'undefined') {
  loadDatabaseStatus();
}
</script>